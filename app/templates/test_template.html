<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Тест</title>

    <!-- Bootstrap -->
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
        rel="stylesheet"
    >
</head>
<body class="bg-light">

<div class="container py-4">
    <h2 class="text-center mb-4">Тест</h2>

    <form id="quizForm">
        {% for q in questions %}
        {% set q_index = loop.index0 %}
        <div class="card mb-3">
            <div class="card-body">

                <p class="fw-bold">{{ loop.index }}. {{ q.question }}</p>

                {% for ans in q.answers %}
                    {% for text, val in ans.items() %}
                        {% set a_index = loop.index0 %}
                        <div class="form-check">
                            <input class="form-check-input"
                                   type="radio"
                                   name="question_{{ q_index }}"
                                   value="{{ val }}"
                                   id="q{{ q_index }}_{{ a_index }}">
                            <label class="form-check-label" for="q{{ q_index }}_{{ a_index }}">
                                {{ text }}
                            </label>
                        </div>
                    {% endfor %}
                {% endfor %}

            </div>
        </div>
        {% endfor %}

        <button type="button" class="btn btn-primary w-100 mb-3" onclick="checkAnswers()">Проверить</button>

        {% if user_id %}
        <input type="hidden" id="userId" value="{{ user_id }}">
        {% endif %}
    </form>
</div>

<script>
function checkAnswers() {
    const questions = document.querySelectorAll('.card');
    let correct = 0;
    let total = questions.length;
    let results = [];
    const timestamp = new Date().toLocaleString();

    // Получаем user_id из скрытого поля или из URL
    let userId = document.getElementById('userId')?.value;
    if (!userId) {
        // Пытаемся извлечь из URL
        const urlParams = new URLSearchParams(window.location.search);
        userId = urlParams.get('user_id');
    }

    questions.forEach((qBlock, qIndex) => {
        const qText = qBlock.querySelector('.fw-bold').textContent.trim();

        const radios = qBlock.querySelectorAll('input[type="radio"]');
        let answered = false;
        let isCorrect = false;
        let selectedAnswer = "";

        radios.forEach(radio => {
            if (radio.checked) {
                answered = true;
                selectedAnswer = radio.parentElement.textContent.trim();
                if (radio.value === "1" || radio.value === 1) isCorrect = true;
            }
        });

        if (isCorrect) correct++;

        results.push({
            question: qText,
            selectedAnswer: selectedAnswer,
            isCorrect: isCorrect,
            answered: answered
        });
    });

    const percentage = Math.round((correct / total) * 100);

    const payload = {
        timestamp: timestamp,
        score: correct,
        totalQuestions: total,
        percentage: percentage,
        details: results
    };

    // Формируем URL с user_id
    let url = "/result";
    if (userId) {
        url += `?user_id=${encodeURIComponent(userId)}`;
    }

    fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    })
    .then(r => {
        if (!r.ok) {
            throw new Error(`HTTP error! status: ${r.status}`);
        }
        return r.json();
    })
    .then(data => {
        console.log("Result saved:", data);
    })
    .catch(err => {
        console.error("Send error:", err);
        alert("Ошибка при отправке результатов: " + err.message);
    });
}
</script>

</body>
</html>